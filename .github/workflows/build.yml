name: Build, Release, and Deploy Docs

on:
  push:
    branches: [ "master" ]
    tags:
      - 'v*' # Trigger on tags like v1.0, v2.3.4
  pull_request:
    branches: [ "master" ]

env:
  BUILD_TYPE: Release

jobs:
  # ===============================================================
  # JOB 0: Filtruj zmiany w plikach
  # ===============================================================
  changes:
    runs-on: ubuntu-latest
    outputs:
      src_files: ${{ steps.filter.outputs.src_files }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            src_files:
              - 'src/**'
              - 'include/**'
              - 'luadoc/**'
              - 'pack/**'
              - 'CMakeLists.txt'
              - '.github/workflows/**'

  # ===============================================================
  # JOB 1: Build - z poprawionym warunkiem 'if'
  # ===============================================================
  build:
    needs: changes
    # OSTATECZNA POPRAWKA: Dodajemy warunek sprawdzający, czy to jest push taga
    if: >
      needs.changes.outputs.src_files == 'true' ||
      github.event_name == 'pull_request' ||
      startsWith(github.ref, 'refs/tags/')
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x86
      - name: Configure RPFM
        run: |
          Invoke-WebRequest -Uri "https://github.com/Frodo45127/rpfm/releases/download/v4.3.14/rpfm-v4.3.14-x86_64-pc-windows-msvc.zip" -OutFile "rpfm.zip"
          Expand-Archive -Path "rpfm.zip" -DestinationPath "rpfm"
          $rpfmPath = Join-Path (PWD) 'rpfm'; echo $rpfmPath | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      - name: Configure CMake
        run: cmake -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DLUA_VERSION="5.1.2" -G Ninja
      - name: Build Project (including Docs)
        run: cmake --build ${{github.workspace}}/build --config ${{env.BUILD_TYPE}}
      - name: Archive Release Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-assets
          path: ${{github.workspace}}/build/release/*
      - name: Archive Documentation Artifact
        uses: actions/upload-artifact@v4
        with:
          name: docs-html
          path: ${{github.workspace}}/luadoc

  # ===============================================================
  # JOB 2: Deploy Docs - Z POPRAWKĄ INSTALACJI PAKIETU
  # ===============================================================
  deploy-docs:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with: { path: main, fetch-depth: '0' }
      - uses: actions/download-artifact@v4
        with: { name: docs-html, path: new-docs }
      - id: docs_dir
        run: |
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            VERSION=$(echo $GITHUB_REF | sed 's/refs\/tags\/v//')
            echo "dir=$VERSION" >> $GITHUB_OUTPUT
          else
            echo "dir=nightly" >> $GITHUB_OUTPUT
          fi
      - uses: actions/checkout@v4
        with: { ref: gh-pages, path: gh-pages }
      - uses: actions/setup-python@v5
        with: { python-version: '3.x' }

      # ===============================================================
      # KLUCZOWA POPRAWKA JEST TUTAJ
      # Instalujemy brakujący pakiet 'packaging' za pomocą pip
      # ===============================================================
      - name: Install Python dependencies
        run: pip install packaging

      - name: Generate dynamic index.html
        run: |
          python main/.github/scripts/generate_doc_index.py \
            main/.github/docs_template/index.template.html \
            gh-pages/index.html \
            gh-pages \
            ${{ steps.docs_dir.outputs.dir }} \
            main
      - name: Prepare deployment directory
        run: |
          mkdir -p gh-pages/${{ steps.docs_dir.outputs.dir }}
          cp -r new-docs/* gh-pages/${{ steps.docs_dir.outputs.dir }}/
      - uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages
          keep_files: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'

  # ===============================================================
  # JOB 3: Create an official GitHub Release (for tags) - OSTATECZNA POPRAWKA AWK
  # ===============================================================
  create-official-release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download release assets
        uses: actions/download-artifact@v4
        with: { name: release-assets, path: release-assets }

      - name: Remove useless stamp file
        run: rm -f release-assets/*.stamp

      - name: Create ZIP archive for the release
        id: archive
        run: |
          VERSION=$(echo "${{ github.ref_name }}" | sed 's/^v//')
          ARCHIVE_NAME="libtwdll-${VERSION}.zip"
          zip -r -j "${ARCHIVE_NAME}" release-assets/
          mv "${ARCHIVE_NAME}" release-assets/
          echo "name=${ARCHIVE_NAME}" >> $GITHUB_OUTPUT

      - name: Remove luadoc directory before upload
        run: rm -rf release-assets/luadoc

      - name: Extract Changelog Entry
        id: changelog
        run: |
          VERSION=$(echo "${{ github.ref_name }}" | sed 's/^v//')
          sed -i 's/\r$//' CHANGELOG.md
          
          # ===============================================================
          # KLUCZOWA POPRAWKA JEST TUTAJ:
          # Poprawiamy sposób przekazywania zmiennej do 'awk'
          # ===============================================================
          CHANGELOG_BODY=$(awk '/^## \[''"$VERSION"''\]/{f=1;next} /^## \[/{f=0} f' CHANGELOG.md)
          
          if [ -z "$CHANGELOG_BODY" ]; then
            echo "::error::Nie znaleziono wpisu dla wersji '$VERSION' w pliku CHANGELOG.md! Sprawdź format nagłówka '## [$VERSION]'."
            exit 1
          fi
          
          echo "body<<EOF" >> $GITHUB_ENV
          echo "## Quick Download" >> $GITHUB_ENV
          echo "**All files in one package: [\`${{ steps.archive.outputs.name }}\`](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${{ steps.archive.outputs.name }})**" >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV
          echo "---" >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV
          echo "## Changelog" >> $GITHUB_ENV
          echo "$CHANGELOG_BODY" >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV
          echo "---" >> $GITHUB_ENV
          echo "Individual files are attached below." >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Create GitHub Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          body: ${{ env.body }}
          files: release-assets/*

  # ===============================================================
  # JOB 4: Publish the Nightly Release - ZMIENIONA NAZWA NA "DEV BUILD"
  # ===============================================================
  publish-nightly-release:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    permissions:
      contents: write
      actions: write
    steps:
      - name: Cancel previous nightly runs
        uses: styfle/cancel-workflow-action@0.12.1
        with:
          access_token: ${{ github.token }}
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download release assets
        uses: actions/download-artifact@v4
        with: { name: release-assets, path: release-assets }
      - name: Remove useless stamp file
        run: rm -f release-assets/*.stamp
      - name: Create ZIP archive with source code
        run: git archive -o release-assets/source-code.zip HEAD
      - name: Create ZIP archive with binaries
        id: archive
        run: |
          ARCHIVE_NAME="libtwdll-nightly.zip"
          mkdir temp-binaries
          find release-assets -maxdepth 1 -type f \( -name "*.dll" -o -name "*.pack" -o -name "*.exe" -o -name "*.lua" \) -exec cp {} temp-binaries/ \;
          zip -r -j "release-assets/${ARCHIVE_NAME}" temp-binaries/
          echo "name=${ARCHIVE_NAME}" >> $GITHUB_OUTPUT
      - name: Remove luadoc directory before upload
        run: rm -rf release-assets/luadoc
      - name: Prepare Release Notes
        id: prep_notes
        env: { COMMIT_SHA: "${{ github.sha }}" }
        run: |
          {
            echo "This is the latest development build from the **master** branch. Assets are automatically updated on every push."
            echo ""
            echo "## Quick Download"
            echo "**Binaries Pack: [\`${{ steps.archive.outputs.name }}\`](https://github.com/${{ github.repository }}/releases/download/nightly/${{ steps.archive.outputs.name }})**"
            echo "**Source Code: [\`source-code.zip\`](https://github.com/${{ github.repository }}/releases/download/nightly/source-code.zip)**"
            # ... (reszta opisu bez zmian)
          } > release_notes.md
      - name: Ensure 'nightly' release exists and update its body
        env: { GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}" }
        run: |
          # ZMIENIONY TYTUŁ TUTAJ
          gh release view nightly || gh release create nightly --title "Dev Build (from master)" --prerelease --notes "Placeholder"
          gh release edit nightly --title "Dev Build (from master)" --notes-file release_notes.md
      - name: Upload/Overwrite Release Assets (using gh CLI)
        env: { GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}" }
        run: gh release upload nightly release-assets/* --clobber
